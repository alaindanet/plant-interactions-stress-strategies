---
title: "Target Markdown"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
Sys.setlocale("LC_ALL", "en_GB.utf8")
```

# Setup

```{r}
library(targets)
tar_unscript()
```

# Globals

```{targets example-globals, tar_globals = TRUE}
Sys.setlocale("LC_ALL", "en_GB.utf8")
options(tidyverse.quiet = TRUE)
library(tidyverse)
library(magrittr)
library(here)
library(zoo)
library(ecocom)
tar_option_set(packages = c("tidyverse", "here", "magrittr", "lubridate", "INLA", "zoo", "ecocom", "cowplot"))
source(here::here("R","inla_helpers.R"))
source(here::here("R","clean_data.R"))
source(here::here("R","string_replacements.R"))
source(here::here("R","plot.r"))
```

# Targets

```{targets raw-data}
load(here::here("data", "holes_data.RData"))
load(here::here("data", "try2.RData"))
list(
tar_target(surv_raw_data, try2),
tar_target(growth_raw_data, holes_data),
tar_target(leaf_raw_data, read_csv2(here("data-raw", "leafs", "mars", "empty_file_for_traits-2.csv"))),
tar_target(leaf_mass_raw_data, read_csv2(here("data-raw", "data_mars_traits.csv"))),
tar_target(biomass_t0_raw, read_csv2(here::here("data-raw", "biomass_t0.csv")))
)
```

```{targets env_raw_data, tar_simple = TRUE}
january <- read_csv2("data-raw/data_january_env.csv") %>%
  mutate(date = "jan", duration_m = 0)
march <- read_csv2("data-raw/data_mars_env.csv") %>%
  mutate(date = "mar", duration_m = 3)
june <- read_csv2("data-raw/data_juin_env.csv") %>%
  mutate(date = "jun", duration_m = 5)
november <- read_csv2("data-raw/data_nov_env.csv") %>%
  mutate(date = "nov", duration_m = 9) # The table are quite different

rbind(
  january,
  march %>%
    select(-soil.moisture.j2, -soil.moisture.j3, -soil.moisture.j4),
  june %>%
    select(-soil.moisture.j0) %>%
    rename(soil.moisture = soil.moisture.j1) %>%
    mutate(PAR = NA, notes = NA)
  ) %>%
mutate(
  com = ifelse(com %in% c("A", "D", "P"), "Mono", "Poly"),
  ms = ifelse(ms == "0", "Open", "Patch"),
  watering = ifelse(water == "0", "No Watered", "Watered")
  ) %>%
select(-water) %>%
mutate(across(
    c(com, ms, watering, ter, plot, label),
    as.factor)
)

# November removed because soil moisture measurement was done months after
# watering
#,
#  november %>%
#    rename(notes = ...11)
```



```{targets clean-trait-data, eval = TRUE}
list(
  tar_target(treatment_label, get_treatment_by_label(x = growth_raw_data)),
  tar_target(leaf_trait, get_leaf_trait_data(mass_data = leaf_mass_raw_data,
      leaf_data = leaf_raw_data) %>%
    left_join(treatment_label)),
  tar_target(biomass_t0, biomass_t0_raw %>%
  mutate(
    species = tolower(species),
    species = str_replace(species, "pistacia", "pistachia"),
    d = (dia1 + dia2) / 2,
    log_d = log(d),
    h = height,
    log_h = h,
    duration_m = 0,
    bm_above = bio_leaves + bio_stem,
    bm_total = bio_leaves + bio_stem + bio_roots,
    bm_below = bio_roots
  ))
)
```




```{targets clean-growth-data, eval = TRUE}
list(
  tar_target(surv_data,
    surv_raw_data %>%
      mutate(
        duration_m = month(date) + 2,
        surv = ifelse(survival == 0, TRUE, FALSE),
        com = ifelse(com %in% c("A", "D", "P"), "Mono", "Poly"),
        ms = ifelse(ms == "0", "Open", "Patch"),
        watering = ifelse(watering == "0", "No Watered", "Watered"),
      ) %>%
      mutate(across(
        c(com, ms, watering, species, ter, plot, label, ind),
        as.factor)
        )
      ),
    tar_target(growth_data,
      growth_raw_data  %>%
        mutate(duration_m = month(date) + 2) %>%
        mutate(across(c(com, ms, watering, species, ter, plot, label),
        as.factor))
    )
)
```

```{targets data_modelling, eval = TRUE}
list(
  tar_target(surv_data_modelling,
    surv_data %>%
      mutate(
        bm = exp(predict(biomass_modelling$log_mod_bm_tot_h, newdata = surv_data %>% mutate(log_d = log(d), log_h = log(h)))),
        # Center duration in June 2016:
        duration_m = duration_m - 8,
        IDtl = seq_len(nrow(surv_data)),
        IDtli = seq_len(nrow(surv_data))
      )
  ),
  tar_target(pred_surv_data, get_pred_data(x = surv_data_modelling,
    predictor = c("com", "ms", "watering", "species", "duration_m"))),
  tar_target(surv_data_modelling_scaled,
    surv_data_modelling %>%
      mutate(across(biomass_trait, ~scale(.x, center = TRUE, scale = TRUE)[,1])) %>%
      mutate(duration_m = scale(duration_m, center = FALSE, scale = TRUE)[,1])
  ),
  tar_target(leaf_trait_modelling,
    leaf_trait %>%
      mutate(
        IDtl = seq_len(nrow(leaf_trait)),
        IDtli = seq_len(nrow(leaf_trait))
      )
  ),
  tar_target(pred_leaf_data,
    get_pred_data(x = leaf_trait_modelling,
      predictor = c("com", "ms", "watering", "species"))
  ),
  tar_target(leaf_trait_modelling_scaled,
    leaf_trait_modelling %>%
      mutate(across(c("ldmc", "sla"), ~scale(.x, center = TRUE, scale = TRUE)[,1]))
  ),
  tar_target(env_data_modelling,
    env_raw_data %>%
      mutate(
        IDtl = seq_len(nrow(env_raw_data)),
        IDtli = seq_len(nrow(env_raw_data))
      )
    ),
  tar_target(env_data_modelling_scaled,
    env_data_modelling %>%
      mutate(across(c("temperature", "soil.moisture", "PAR"), ~scale(.x, center = TRUE, scale = TRUE)[,1]))
    ),
  tar_target(pred_env_data,
    get_pred_data(x = env_data_modelling,
      predictor = c("ms", "watering", "duration_m"))
  )
)
```


```{targets model-biomass}
list(
  tar_target(biomass_modelling, list(
      # Good model
      log_mod_bm_tot_h = lm(log(bm_total) ~ log_d + log_h + species, biomass_t0),
      mod_bm_tot_h = lm(bm_total ~ (d+h)*species, biomass_t0),
      log_mod_bm_tot_h_sp = lm(log(bm_total) ~ (log_d+log_h)*species, biomass_t0),
      mod_bm_tot = lm(bm_total ~ (d)*species, biomass_t0),
      mod_bm_tot_simple = lm(bm_total ~ (d) + species, biomass_t0),
      log_mod_bm_tot = lm(log(bm_total) ~ (log_d)*species, biomass_t0),
      mod_bm_above = lm(bm_above ~ (d)*species, biomass_t0),
      mod_bm_above_h = lm(bm_above ~ (d+h)*species, biomass_t0)
    )
    ),
  tar_target(biomass_modelling_r2, map_dfr(biomass_modelling,
  ~performance::r2(.x) %>%.[c("R2", "R2_adjusted")],
  .id = "model"
    )
  )
)
```



Set the `tar_simple` chunk option to `TRUE` to define a single target with the
command in the code chunk. The chunk below only contains `biglm(Ozone ~ Wind +
Temp, data)` in the source, but because `tar_simple` is `TRUE`, it is shorthand
for `tar_target(name = fit, command = biglm(Ozone ~ Wind + Temp, data))`. All
other arguments to `tar_target()` are set to their default values (configurable
with `tar_option_set()`).


```{targets inla_surv_model, tar_simple = TRUE, eval = TRUE}
inla(
  survival ~ 1 +
    duration_m + com * ms * watering +
    ter +
    species +
    f(IDtl, model = "z",
      Z = as(model.matrix(~ 0 + ter:label, data = surv_data_modelling), "Matrix")),
    f(IDtli, model = "z",
    Z = as(model.matrix(~ 0 + ter:label:ind, data = surv_data_modelling), "Matrix")),
    data = rbind(surv_data_modelling, pred_surv_data),
    family = "binomial",
    control.compute = list(dic = TRUE, waic = TRUE, cpo = TRUE,
              return.marginals=TRUE, return.marginals.predictor=TRUE),
    control.predictor = list(compute = TRUE, link = 1)
)
```

```{targets inla_surv_sp_model, tar_simple = TRUE, eval = TRUE}
inla(
  survival ~ 1 +
    duration_m + com * ms * watering * species +
    ter +
    f(IDtl, model = "z",
      Z = as(model.matrix(~ 0 + ter:label, data = surv_data_modelling), "Matrix")) +
    f(IDtli, model = "z",
    Z = as(model.matrix(~ 0 + ter:label:ind, data = surv_data_modelling), "Matrix")),
    data = rbind(surv_data_modelling, pred_surv_data),
    family = "binomial",
    control.compute = list(dic = TRUE, waic = TRUE, cpo = TRUE,
              return.marginals=TRUE, return.marginals.predictor=TRUE),
    control.predictor = list(compute = TRUE, link = 1)
)
```

```{targets model-effects, eval=TRUE}
list(
tar_target(inla_surv_effects, get_hpdmarginal_inla(inla_surv_model, type = "fixed")),
tar_target(inla_surv_odd, inla_surv_effects %>%
  mutate(across(c(low, high, mean), ~ exp(.x) - 1))
),
tar_target(inla_surv_perc, inla_surv_effects %>%
  mutate(across(c(low, high, mean), ~ (exp(.x) - 1) * 100))
),
tar_target(inla_surv_pred,
  inla_surv_model$summary.fitted.values[(nrow(surv_data_modelling) + 1):nrow(inla_surv_model$summary.fitted.values),] %>%
    cbind(pred_surv_data[, c("duration_m", "ms", "com", "watering", "species")]) %>%
    as_tibble()
    ),
tar_target(inla_surv_sp_effects, get_hpdmarginal_inla(inla_surv_sp_model, type = "fixed")),
tar_target(inla_surv_sp_odd, inla_surv_sp_effects %>%
  mutate(across(c(low, high, mean), ~ exp(.x) - 1))
),
tar_target(inla_surv_sp_perc, inla_surv_sp_effects %>%
  mutate(across(c(low, high, mean), ~ (exp(.x) - 1) * 100))
),
tar_target(inla_surv_sp_pred,
  inla_surv_sp_model$summary.fitted.values[(nrow(surv_data_modelling) + 1):nrow(inla_surv_sp_model$summary.fitted.values),] %>%
    cbind(pred_surv_data[, c("duration_m", "ms", "com", "watering", "species")]) %>%
    as_tibble()
  )
)
```

## Model for basal diameter and height

```{targets model-biomass-trait, eval = TRUE}
list(
  tar_target(biomass_trait, c("d", "h", "hm", "bm")),
  tar_target(bm_inla,
    tibble(
      response = biomass_trait,
      mod = list(try(inla(
            formula = formula_inla(
              response = biomass_trait,
              dataset_name = "surv_data_modelling",
              plot_effect = FALSE
              ),
            control.compute = list(dic = TRUE, waic = TRUE, cpo = TRUE,
              return.marginals=TRUE, return.marginals.predictor=TRUE),
            control.predictor = list(compute = T),
            verbose = F,
            data = rbind(surv_data_modelling, pred_surv_data),
            )))),
    pattern = map(biomass_trait)
    ),
  tar_target(bm_inla_pred,
    bm_inla %>%
      mutate(pred = map(mod,
          ~.x$summary.fitted.values[(nrow(surv_data_modelling) + 1):nrow(.x$summary.fitted.values),] %>%
        cbind(pred_surv_data[, c("duration_m", "ms", "com", "watering", "species")]) %>%
        as_tibble())) %>%
    select(-mod) %>%
    unnest(cols = c(pred))
  ),
  tar_target(bm_inla_effects, format_inla_model_list(x = bm_inla)),
  tar_target(bm_inla_scaled,
    tibble(
      response = biomass_trait,
      mod = list(try(inla(
            formula = formula_inla(
              response = biomass_trait,
              dataset_name = "surv_data_modelling_scaled",
              plot_effect = FALSE),
            control.compute = list(dic = TRUE, waic = TRUE, cpo = TRUE,
              return.marginals=TRUE, return.marginals.predictor=TRUE),
            control.predictor = list(compute = T),
            verbose = F,
            data = surv_data_modelling_scaled,
            )))),
    pattern = map(biomass_trait)
    ),
  tar_target(bm_inla_scaled_effects, format_inla_model_list(x = bm_inla_scaled)),
  tar_target(bm_inla_sp,
    tibble(
      response = biomass_trait,
      mod = list(try(inla(
            formula = formula_inla(
              response = biomass_trait,
              species = TRUE,
              dataset_name = "surv_data_modelling",
              plot_effect = FALSE),
            control.compute = list(dic = TRUE, waic = TRUE, cpo = TRUE,
              return.marginals=TRUE, return.marginals.predictor=TRUE),
            control.predictor = list(compute = T),
            verbose = F,
            data = rbind(surv_data_modelling, pred_surv_data),
            )))),
    pattern = map(biomass_trait)
    ),
  tar_target(bm_inla_sp_effects, format_inla_model_list(x = bm_inla_sp)),
  tar_target(bm_inla_sp_pred,
    bm_inla_sp %>%
      mutate(pred = map(mod,
          ~.x$summary.fitted.values[(nrow(surv_data_modelling) + 1):nrow(.x$summary.fitted.values),] %>%
        cbind(pred_surv_data[, c("duration_m", "ms", "com", "watering", "species")]) %>%
        as_tibble())) %>%
    select(-mod) %>%
    unnest(cols = c(pred))
  ),
  tar_target(bm_inla_sp_scaled,
    tibble(
      response = biomass_trait,
      mod = list(try(inla(
            formula = formula_inla(
              response = biomass_trait,
              species = TRUE,
              dataset_name = "surv_data_modelling_scaled",
              plot_effect = FALSE),
            control.compute = list(dic = TRUE, waic = TRUE, cpo = TRUE,
              return.marginals=TRUE, return.marginals.predictor=TRUE),
            control.predictor = list(compute = T),
            verbose = F,
            data = surv_data_modelling_scaled
            )))),
    pattern = map(biomass_trait)
    ),
  tar_target(bm_inla_sp_scaled_effects, format_inla_model_list(x = bm_inla_sp_scaled))
)
```


## Compute plant-plant interaction from model prediction

```{targets pp_int, tar_simple = TRUE}
rbind(bm_inla_sp_pred,
  inla_surv_sp_pred %>%
    mutate(response = "survival")
  ) %>%
  select(-c(sd, `0.5quant`, mode)) %>%
  pivot_wider(
    names_from = ms,
    names_glue = "{ms}_{.value}",
    values_from = c(mean, `0.025quant`, `0.975quant`)
  ) %>%
  mutate(
    inta = n_int_a(without = Open_mean, with_nbs = Patch_mean),
    inta_low = n_int_a(without = Open_0.025quant, with_nbs = Patch_0.025quant),
    inta_high = n_int_a(without = Open_0.975quant, with_nbs = Patch_0.975quant),
    intc = n_int_c(without = Open_mean, with_nbs = Patch_mean),
    intc_low = n_int_c(without = Open_0.025quant, with_nbs = Patch_0.025quant),
    intc_high = n_int_c(without = Open_0.975quant, with_nbs = Patch_0.975quant)
  )
```

```{targets pp_int_global, tar_simple = TRUE}
rbind(bm_inla_pred, inla_surv_pred %>% mutate(response = "survival")) %>%
  select(-c(sd, `0.5quant`, mode)) %>%
  pivot_wider(
    names_from = ms,
    names_glue = "{ms}_{.value}",
    values_from = c(mean, `0.025quant`, `0.975quant`)
  ) %>%
  mutate(
    inta = n_int_a(without = Open_mean, with_nbs = Patch_mean),
    inta_low = n_int_a(without = Open_0.025quant, with_nbs = Patch_0.025quant),
    inta_high = n_int_a(without = Open_0.975quant, with_nbs = Patch_0.975quant),
    intc = n_int_c(without = Open_mean, with_nbs = Patch_mean),
    intc_low = n_int_c(without = Open_0.025quant, with_nbs = Patch_0.025quant),
    intc_high = n_int_c(without = Open_0.975quant, with_nbs = Patch_0.975quant)
  )
```


## Model for leaf trait

```{targets model-leaf-trait, eval = TRUE}
list(
  tar_target(leaf_trait_var, c("ldmc", "sla")),
  tar_target(leaf_inla,
    tibble(
      response = leaf_trait_var,
      mod = list(try(inla(
            formula = formula_inla(
              response = leaf_trait_var,
              time = FALSE,
              plot_effect = FALSE,
              dataset_name = "leaf_trait_modelling"),
            control.compute = list(dic = TRUE, waic = TRUE, cpo = TRUE,
              return.marginals=TRUE, return.marginals.predictor=TRUE),
            control.predictor = list(link = 1, compute = T),
            verbose = F,
            data = rbind(leaf_trait_modelling, pred_leaf_data),
            )))),
    pattern = map(leaf_trait_var)
    ),
  tar_target(leaf_inla_pred,
    leaf_inla %>%
      mutate(pred = map(mod,
          ~.x$summary.fitted.values[(nrow(leaf_trait_modelling) + 1):nrow(.x$summary.fitted.values),] %>%
        cbind(pred_leaf_data[, c("ms", "com", "watering", "species")]) %>%
        as_tibble())) %>%
    select(-mod) %>%
    unnest(cols = c(pred))
  ),
  tar_target(leaf_inla_scaled,
    tibble(
      response = leaf_trait_var,
      mod = list(try(inla(
            formula = formula_inla(
              response = leaf_trait_var,
              time = FALSE,
              plot_effect = FALSE,
              dataset_name = "leaf_trait_modelling_scaled"),
            control.compute = list(dic = TRUE, waic = TRUE, cpo = TRUE,
              return.marginals=TRUE, return.marginals.predictor=TRUE),
            control.predictor = list(link = 1, compute = T),
            verbose = F,
            data = leaf_trait_modelling_scaled,
            )))),
    pattern = map(leaf_trait_var)
    ),
  tar_target(leaf_inla_effects_scaled, format_inla_model_list(x = leaf_inla_scaled)),
  tar_target(leaf_inla_sp,
    tibble(
      response = leaf_trait_var,
      mod = list(try(inla(
            formula = formula_inla(
              response = leaf_trait_var,
              time = FALSE,
              species = TRUE,
              plot_effect = FALSE,
              dataset_name = "leaf_trait_modelling"),
            control.compute = list(dic = TRUE, waic = TRUE, cpo = TRUE,
              return.marginals=TRUE, return.marginals.predictor=TRUE),
            control.predictor = list(link = 1, compute = T),
            verbose = F,
            data = rbind(leaf_trait_modelling, pred_leaf_data),
            )))),
    pattern = map(leaf_trait_var)
    ),
  tar_target(leaf_inla_sp_pred,
    leaf_inla_sp %>%
      mutate(pred = map(mod,
          ~.x$summary.fitted.values[(nrow(leaf_trait_modelling) + 1):nrow(.x$summary.fitted.values),] %>%
        cbind(pred_leaf_data[, c("ms", "com", "watering", "species")]) %>%
        as_tibble())) %>%
    select(-mod) %>%
    unnest(cols = c(pred))
  ),
  tar_target(leaf_inla_sp_effect, format_inla_model_list(x = leaf_inla_sp)),
  tar_target(leaf_inla_sp_scaled,
    tibble(
      response = leaf_trait_var,
      mod = list(try(inla(
            formula = formula_inla(
              response = leaf_trait_var,
              time = FALSE,
              species = TRUE,
              plot_effect = FALSE,
              dataset_name = "leaf_trait_modelling_scaled"),
            control.compute = list(dic = TRUE, waic = TRUE, cpo = TRUE,
              return.marginals=TRUE, return.marginals.predictor=TRUE),
            control.predictor = list(link = 1, compute = T),
            verbose = F,
            data = leaf_trait_modelling_scaled,
            )))),
    pattern = map(leaf_trait_var)
    ),
  tar_target(leaf_inla_sp_scaled_effects, format_inla_model_list(x = leaf_inla_sp_scaled))
)
```




# Supplementary

## Environmental values

```{targets env_plot, tar_simple = TRUE}
env_raw_data %>%
  pivot_longer(c(soil.moisture, temperature, PAR), names_to = "variable",
    values_to = "values") %>%
  mutate(
    variable = response_replacement()[variable],
    ms = recode_factor(ms, !!!ms_replacement()),
    watering = recode_factor(watering, !!!water_replacement()),
    duration_m = duration_m - 5
    ) %>%
  select(-date) %>%
  left_join(date_nb_month) %>%
  ggplot(aes(y = values, x = date,
      color = watering,
      group = interaction(date, watering, ms),
      linetype = ms)) +
  geom_boxplot() +
  facet_wrap(~variable, scales = "free_y") +
  scale_x_date(date_labels = "%b", breaks = date_nb_month$date) +
  scale_color_manual(values = wet_dry_color()) +
  labs(
    color = "Watering",
    linetype = "Microsite",
    y = "Values",
    x = "Month") +
  theme_bw()
```

```{targets simple-env-model}
list(
  tar_target(mod_env, list(
      soil.moisture = lm(soil.moisture ~ duration_m + watering * ms, env_raw_data),
      temperature = lm(temperature ~ duration_m + watering * ms, env_raw_data),
      PAR = lm(PAR ~ duration_m + watering * ms, env_raw_data)
      )),
  tar_target(mod_env_r2, map_dfr(mod_env,
  ~performance::r2(.x) %>%.[c("R2", "R2_adjusted")],
  .id = "model") %>%
    mutate(
      model = response_replacement()[model]
    )
    ),
  tar_target(mod_env_effect,
    map_dfr(mod_env, ~broom::tidy(.x), .id = "model") %>%
      mutate(
        model = response_replacement()[model],
        term = str_replace_all(term, term_replacement()),
        term = str_replace(term, "\n", " "),
        p.value = round(p.value, 5)
        ) %>%
    janitor::clean_names() %>%
    rename_with(~str_to_sentence(.x)) %>%
    rename(
      `Response` = Model,
      `Std error` = Std_error,
      `P-value` = P_value,
      ))
)
```

```{targets model-env, eval = TRUE}
list(
  tar_target(env_var, c("temperature", "soil.moisture", "PAR")),
  tar_target(env_inla,
    tibble(
      response = env_var,
      mod = list(try(inla(
            formula = formula_inla_env(
              response = env_var,
              time = TRUE,
              plot_effect = FALSE,
              dataset_name = "env_data_modelling"),
            control.compute = list(dic = TRUE, waic = TRUE, cpo = TRUE,
              return.marginals=TRUE, return.marginals.predictor=TRUE),
            control.predictor = list(link = 1, compute = T),
            verbose = F,
            data = rbind(env_data_modelling, pred_env_data),
            )))),
    pattern = map(env_var)
    ),
  tar_target(env_inla_pred,
    env_inla %>%
      mutate(pred = map(mod,
          ~.x$summary.fitted.values[(nrow(env_data_modelling) + 1):nrow(.x$summary.fitted.values),] %>%
        cbind(pred_env_data[, c("ms", "watering", "duration_m")]) %>%
        as_tibble())) %>%
    select(-mod) %>%
    unnest(cols = c(pred))
  ),
  tar_target(env_inla_scaled,
    tibble(
      response = env_var,
      mod = list(try(inla(
            formula = formula_inla_env(
              response = env_var,
              time = TRUE,
              plot_effect = FALSE,
              dataset_name = "env_data_modelling_scaled"),
            control.compute = list(dic = TRUE, waic = TRUE, cpo = TRUE,
              return.marginals=TRUE, return.marginals.predictor=TRUE),
            control.predictor = list(link = 1, compute = T),
            verbose = F,
            data = env_data_modelling_scaled,
            )))),
    pattern = map(env_var)
    ),
  tar_target(env_inla_effects_scaled, format_inla_model_list(x = env_inla_scaled)),
  tar_target(env_inla_effects, format_inla_model_list(x = env_inla))
  )
```

## Statistics

```{targets obs-fit}
list(
  tar_target(p_obs_fit,
    map2(bm_inla$response, bm_inla$mod,
      ~ plot_obs_fitted_inla(mod_inla = .y,
        dataset = mutate(surv_data_modelling, surv = survival),
        resp = .x,
        pred_nrows = nrow(pred_surv_data),
        return_df = FALSE) +
      geom_rug(alpha = .5) +
      theme_bw()
    )
    ),
  tar_target(p_obs_fit_surv,
    plot_obs_fitted_inla(mod_inla = inla_surv_model,
      dataset = mutate(surv_data_modelling, surv = survival),
      resp = "surv",
      pred_nrows = nrow(pred_surv_data),
      return_df = TRUE) %>%
    arrange(fit) %>%
    mutate(id = seq_len(n())) %>%
    ggplot(aes(x = id, y = obs)) +
    geom_point() +
    geom_line(aes(y = fit)) +
    labs(x = "Observation id", y = "Survival") +
    theme_bw()
  ),
  tar_target(p_obs_fit_leaf,
    map2(leaf_inla$response, leaf_inla$mod,
      ~ plot_obs_fitted_inla(mod_inla = .y,
        dataset = leaf_trait_modelling,
        resp = .x,
        pred_nrows = nrow(pred_leaf_data),
        return_df = FALSE) +
      geom_rug(alpha = .5) +
      theme_bw()
    )
  ),
  tar_target(p_obs_fit_sp,
    map2(bm_inla_sp$response, bm_inla_sp$mod,
      ~ plot_obs_fitted_inla(mod_inla = .y,
        dataset = mutate(surv_data_modelling, surv = survival),
        resp = .x,
        pred_nrows = nrow(pred_surv_data),
        return_df = FALSE) +
      geom_rug(alpha = .5) +
      theme_bw()
    )
    ),
  tar_target(p_obs_fit_sp_leaf,
    map2(leaf_inla_sp$response, leaf_inla_sp$mod,
      ~ plot_obs_fitted_inla(mod_inla = .y,
        dataset = leaf_trait_modelling,
        resp = .x,
        pred_nrows = nrow(pred_leaf_data),
        return_df = FALSE) +
      geom_rug(alpha = .5) +
      theme_bw()
    )
    ),
  tar_target(p_obs_fit_surv_sp,
    plot_obs_fitted_inla(mod_inla = inla_surv_sp_model,
      dataset = mutate(surv_data_modelling, surv = survival),
      resp = "surv",
      pred_nrows = nrow(pred_surv_data),
      return_df = TRUE) %>%
    arrange(fit) %>%
    mutate(id = seq_len(n())) %>%
    ggplot(aes(x = id, y = obs)) +
    geom_point() +
    geom_line(aes(y = fit)) +
    labs(x = "Observation id", y = "Survival") +
    theme_bw()
  ),
  tar_target(p_obs_fit_tot, plot_grid(
    p_obs_fit_surv, p_obs_fit[[1]],
    p_obs_fit_leaf[[1]], p_obs_fit_leaf[[2]],
    labels = "auto"
    )
  ),
  tar_target(p_obs_fit_sp_tot, plot_grid(
    p_obs_fit_surv_sp, p_obs_fit_sp[[1]],
    p_obs_fit_sp_leaf[[1]], p_obs_fit_sp_leaf[[2]],
    labels = "auto"
    )
  )
)
```

```{targets random-effects}
list(
  tar_target(inla_surv_random_effect,
    tibble(
      level = c("community", "species"),
      rand = map(list(inla_surv_model, inla_surv_sp_model),
        ~ get_hpdmarginal_inla(.x, type = "rand")
      )
      ) %>%
    unnest(cols = rand)
    ),
  tar_target(bm_inla_rand_effects,
    rbind(
      bm_inla %>%
        mutate(level = "community"),
      bm_inla_sp %>%
        mutate(level = "species")
      ) %>%
    mutate(rand = map(mod, ~ try(get_hpdmarginal_inla(.x, type = "rand")))) %>%
    select(-mod) %>%
    filter(!map_chr(rand, ~class(.x)[1]) == "try-error") %>%
    unnest(cols = rand)
  ),
  tar_target(leaf_inla_rand_effects,
    rbind(
      leaf_inla %>%
        mutate(level = "community"),
      leaf_inla_sp %>%
        mutate(level = "species")
      ) %>%
    mutate(rand = map(mod, ~ get_hpdmarginal_inla(.x, type = "rand"))) %>%
    select(-mod) %>%
    unnest(cols = rand)
  )
)
```
```{r, eval = FALSE}
tar_load(c(leaf_inla, leaf_inla_sp))
tar_load(c(leaf_inla_rand_effects, leaf_inla_sp_effect))
leaf_inla_rand_effects %>%
  filter(response == "ldmc")
rbind(
      leaf_inla %>%
        mutate(level = "community"),
      leaf_inla_sp %>%
        mutate(level = "species")
      ) %>%
    mutate(rand = map(mod, ~ get_hpdmarginal_inla(.x, type = "rand"))) %>%
    select(-mod) %>%
    unnest(cols = rand)
```


```{targets var-fitted}
list(
  tar_target(inla_surv_var_fitted, tibble(
      level = c("community", "species"),
      rand = map(list(inla_surv_model, inla_surv_sp_model),
        function(y) {
          map_dbl(y$marginals.fitted.values,
            ~var(inla.rmarginal(1000, .x))
          )
        }
          )
      )),
  tar_target(bm_inla_var_fitted,
    rbind(
      bm_inla %>%
        mutate(level = "community"),
      bm_inla_sp %>%
        mutate(level = "species")
      ) %>%
    mutate(rand = map(mod,
        function(y) {
          map_dbl(y$marginals.fitted.values, ~var(inla.rmarginal(1000, .x)))
        }
      )) %>%
    select(-mod)
  ),
  tar_target(leaf_inla_var_fitted,
    rbind(
      leaf_inla %>%
        mutate(level = "community"),
      leaf_inla_sp %>%
        mutate(level = "species")
      ) %>%
    mutate(rand = map(mod,
        function(y) {
          map_dbl(y$marginals.fitted.values, ~var(inla.rmarginal(1000, .x)))
        }
      )
    ) %>%
    select(-mod)
  )
  )
```

```{targets pred-samp}
list(
  tar_target(inla_surv_pred_samp,
    tibble(
      level = c("community", "species"),
      samp = map(
        list(inla_surv_model, inla_surv_sp_model),
        ~inla_sampling_from_pred(
        model = .x,
        pred_data = pred_surv_data,
        nsamp = 1000)
      )
      )),
  tar_target(bm_inla_pred_samp,
    rbind(
      bm_inla %>%
        mutate(level = "community"),
      bm_inla_sp %>%
        mutate(level = "species")
      ) %>%
    mutate(samp = map(mod,
        ~inla_sampling_from_pred(model = .x, pred_data = pred_surv_data, nsamp = 1000)
      )
      ) %>%
    select(-mod)
  ),
tar_target(leaf_inla_pred_samp,
  rbind(
    leaf_inla %>%
      mutate(level = "community"),
    leaf_inla_sp %>%
      mutate(level = "species")
    ) %>%
  mutate(samp = map(mod,
      ~inla_sampling_from_pred(model = .x, pred_data = pred_surv_data, nsamp = 1000)
    )
    ) %>%
  select(-mod)
)
)
```

```{targets inta-samp}
list(
  tar_target(inta_surv_pred,
    inla_surv_pred_samp %>%
      mutate(
        inta = map(samp,
          function (x) {
            x %>%
              pivot_wider(names_from = "ms", values_from = "value") %>%
              mutate(
                inta = n_int_a(without = Open, with_nbs = Patch)
              )
          })
        ) %>%
    select(-samp) %>%
    unnest(cols = c(inta))
  ),
  tar_target(inta_surv_pred_ci,
    inta_surv_pred %>%
      group_by(level, duration_m, com, watering, species) %>%
      summarise(
        mean = mean(inta),
        hpd = list(tibble(
            lower = coda::HPDinterval(coda::as.mcmc(inta), prob = .8)[1],
            upper = coda::HPDinterval(coda::as.mcmc(inta), prob = .8)[2])),
        .groups = "drop"
        ) %>%
      unnest(cols = c(hpd))
    ),
  tar_target(inta_bm_pred,
    bm_inla_pred_samp %>%
      filter(response == "bm") %>%
      mutate(
        inta = map(samp,
          function (x) {
            x %>%
              pivot_wider(names_from = "ms", values_from = "value") %>%
              mutate(
                inta = n_int_a(without = Open, with_nbs = Patch)
              )
          })
        ) %>%
      select(-samp) %>%
      unnest(cols = c(inta))
    ),
  tar_target(inta_bm_pred_ci,
    inta_bm_pred %>%
      group_by(level, duration_m, com, watering, species) %>%
      summarise(
        mean = mean(inta),
        hpd = list(tibble(
            lower = coda::HPDinterval(coda::as.mcmc(inta), prob = .8)[1],
            upper = coda::HPDinterval(coda::as.mcmc(inta), prob = .8)[2])),
        .groups = "drop"
        ) %>%
      unnest(cols = c(hpd))
    )
)
```

```{targets plot-nint}
list(
  tar_target(p_bm_pp_ci,
    inta_bm_pred_ci %>%
      left_join(date_nb_month) %>%
      filter(species == "anthyllis", level == "community") %>%
      mutate(
        watering = recode_factor(watering, !!!water_replacement()),
        com = recode_factor(com, !!!com_replacement()),
      ) %>%
      ggplot(aes(y = mean, x = date, color = watering, shape = com)) +
      geom_point(size = 3) +
      geom_line() +
      geom_ribbon(aes(ymin = lower, ymax = upper, fill = watering), alpha = .1,
        color = NA) +
      scale_x_date(date_labels = "%b", breaks = date_nb_month$date) +
      scale_color_manual(values = wet_dry_color()) +
      scale_fill_manual(values = wet_dry_color()) +
      labs(
        y = "Nurse net effect (Biomass)",
        x = "Month") +
      theme_bw()
  ),
  tar_target(p_surv_pp_ci,
    inta_surv_pred_ci %>%
    left_join(date_nb_month) %>%
      filter(species == "anthyllis", level == "community") %>%
      mutate(
      com = recode_factor(com, !!!com_replacement()),
      watering = recode_factor(watering, !!!water_replacement()),
      ) %>%
      ggplot(aes(y = mean, x = date, color = watering, shape = com)) +
      geom_point(size = 3) +
      geom_line() +
      geom_ribbon(aes(ymin = lower, ymax = upper, fill = watering), alpha = .1,
        color = NA) +
      scale_x_date(date_labels = "%b", breaks = date_nb_month$date) +
      scale_color_manual(values = wet_dry_color()) +
      scale_fill_manual(values = wet_dry_color()) +
      labs(
        y = "Nurse net effect (Survival)",
        x = "Month",
        color = "Watering", fill = "Watering", shape = "Diversity"
        ) +
      theme_bw()
    )
)
```

```{targets p-int}
list(
  tar_target(p_int_global_surv, pp_int_global %>%
    filter(response == c("survival"), species == "anthyllis") %>%
    mutate(
      com = recode_factor(com, !!!com_replacement()),
      watering = recode_factor(watering, !!!water_replacement()),
    ) %>%
    left_join(date_nb_month) %>%
    ggplot(aes(y = inta, x = date, color = watering, shape = com, fill = watering), alpha = 1) +
    geom_line() +
    geom_point(size = 3) +
    geom_hline(yintercept = 0) +
    geom_ribbon(aes(ymin = inta_low, ymax = inta_high), alpha = .1, color = NA) +
    scale_x_date(date_labels = "%b", breaks = date_nb_month$date) +
    scale_color_manual(values = wet_dry_color()) +
    scale_fill_manual(values = wet_dry_color()) +
    labs(
      y = "Nurse net effect (Survival)",
      x = "Month") +
    theme_bw()),
  tar_target(p_int_global_bm, pp_int_global %>%
    filter(response == c("bm"), species == "anthyllis") %>%
    mutate(
      com = recode_factor(com, !!!com_replacement()),
      watering = recode_factor(watering, !!!water_replacement()),
      ) %>%
    left_join(date_nb_month) %>%
    ggplot(aes(y = inta, x = date, color = watering, shape = com, fill = watering), alpha = 1) +
    geom_line() +
    geom_point(size = 3) +
    geom_hline(yintercept = 0) +
    geom_ribbon(aes(ymin = inta_low, ymax = inta_high), alpha = .1, color = NA) +
    scale_x_date(date_labels = "%b", breaks = date_nb_month$date) +
    scale_color_manual(values = wet_dry_color()) +
    scale_fill_manual(values = wet_dry_color()) +
    labs(
      y = "Nurse net effect (Biomass)",
      x = "Month",
      color = "Watering", fill = "Watering", shape = "Diversity"
      ) +
    theme_bw()),
  tar_target(p_int_global, plot_grid(
      p_int_global_surv + theme(legend.position = "none"),
      p_int_global_bm + theme(legend.position = "none"),
      ncol = 2,
      rel_widths = c(.6, .4),
      labels = c("a", "b"))
  )
)
```


```{targets term2rm, tar_simple = TRUE}
c("(Intercept)", "ter2", "ter3", "ter4", "speciesdorycnium", "speciespistachia")
```

```{targets date_nb_month, tar_simple = TRUE}
surv_data_modelling %>%
  distinct(date, duration_m) %>%
  mutate(date = as.Date(date))
```


```{targets mod-plot}
list(
  tar_target(p_surv,
    plot_inla_fixed_effect(inla_surv_odd,
      color_var = NULL,
      intercept = 0,
      term_to_rm = term2rm) +
    labs(x = latex2exp::TeX("Survival odd-ratios $(e^\\beta - 1)$")) +
    theme(axis.title.y = element_blank())),
  tar_target(p_bm,
    plot_inla_fixed_effect(
      bm_inla_effects %>% filter(response == "bm"),
      color_var = NULL, intercept = 0, term_to_rm = term2rm) +
    labs(x = "Standardised coefficients (Biomass)") +
    theme(axis.title.y = element_blank())
  ),
  tar_target(p_other_surv,
    plot_inla_fixed_effect(inla_surv_odd,
      color_var = NULL,
      intercept = 0,
      term_to_rm = unique(inla_surv_odd$term)[!unique(inla_surv_odd$term) %in% term2rm]) +
    labs(x = latex2exp::TeX("Survival odd-ratios $(e^\\beta - 1)$")) +
    theme(axis.title.y = element_blank())
  ),
  tar_target(p_other_bm,
    plot_inla_fixed_effect(
      bm_inla_effects %>% filter(response == "bm"),
      color_var = NULL, intercept = 0,
      term_to_rm = unique(bm_inla_effects$term)[!unique(bm_inla_effects$term) %in% term2rm]) +
    labs(x = "Standardised coefficients (Biomass)") +
    theme(axis.title.y = element_blank())
  ),
  tar_target(p_other_leaf,
    leaf_inla_effects_scaled %>%
      mutate(response = str_to_upper(response)) %>%
      plot_inla_fixed_effect(.,
        intercept = 0,
        term_to_rm = unique(leaf_inla_effects_scaled$term)[!unique(leaf_inla_effects_scaled$term) %in% term2rm]) +
      labs(x = "Standardised coefficients", color = "Leaf trait") +
      scale_color_manual(values = trait_color()) +
      theme(axis.title.y = element_blank())
  )
)
```

```{targets fig2, tar_simple = TRUE}
plot_grid(
  plot_grid(
    p_surv,
    p_bm,
    labels = c("a", "b")
    ),
  plot_grid(
    p_surv_pp_ci + theme(legend.position = "none"),
    p_bm_pp_ci + theme(legend.position = "none"),
    labels = c("c", "d")
    ),
  get_legend(p_surv_pp_ci + theme(legend.position = "bottom")),
  rel_heights = c(1.2, 1.0, .1),
  nrow = 3
)
```

```{targets var_fitted, tar_simple = TRUE}
rbind(leaf_inla_var_fitted, bm_inla_var_fitted,
  inla_surv_var_fitted %>%
    mutate(response = "survival"))
```


```{targets var_rand_effect, tar_simple = TRUE}
rbind(leaf_inla_rand_effects,
  bm_inla_rand_effects,
  inla_surv_random_effect %>%
    mutate(response = "survival")
  ) %>%
  group_by(level) %>%
  nest() %>%
  mutate(ti = map(data, get_std_inla_from_rand)) %>%
  select(-data) %>%
  unnest(cols = ti)
```

```{targets r2, tar_simple = TRUE}
var_fitted %>%
  left_join(var_rand_effect, by = c("response", "level")) %>%
  filter(!is.na(epsilon)) %>%
  #mutate(IDtp = ifelse(is.na(IDtp), 0, IDtp)) %>%# Because bm has no plot random effects
  mutate(
    r2_mvp_marg = pmap(
      list(rand, IDtl, epsilon),
      ~r2_mvp(var_pred = ..1, std_intercept = c(..2), epsilon = ..3, type = "marginal")
      ),
    r2_mvp_cond = pmap(
      list(rand, IDtl, epsilon),
      ~r2_mvp(var_pred = ..1, std_intercept = c(..2), epsilon = ..3, type = "conditional")
      ),
    r2_mvp_marg_mean = map_dbl(r2_mvp_marg, mean),
    r2_mvp_marg_med = map_dbl(r2_mvp_marg, median),
    r2_mvp_marg_sd = map_dbl(r2_mvp_marg, sd),
    r2_mvp_cond_mean = map_dbl(r2_mvp_cond, mean),
    r2_mvp_cond_med = map_dbl(r2_mvp_cond, median),
    r2_mvp_cond_sd = map_dbl(r2_mvp_cond, sd),
    lab_r2_marg = paste0("~~~~R^2 == ", round(r2_mvp_marg_med, 2)),
    lab_r2_cond = paste0("~~~~R^2 == ", round(r2_mvp_cond_med, 2)),
    r2_mvp_marg95hpd = map(r2_mvp_marg, ~coda::HPDinterval(coda::as.mcmc(.x))),
    r2_mvp_marg95hpdci = map2_chr(r2_mvp_marg95hpd, r2_mvp_marg_mean,
      ~paste0(
        format(round(.y, 2), nsmall = 2),
        " [",
        format(round(.x[, "lower"], 2), nsmall = 2),
        ",",
        format(round(.x[, "upper"], 2), nsmall = 2),
        "]")
      ),
    r2_mvp_cond95hpd = map(r2_mvp_cond, ~coda::HPDinterval(coda::as.mcmc(.x))),
    r2_mvp_cond95hpdci = map2_chr(r2_mvp_cond95hpd, r2_mvp_cond_mean,
      ~paste0(
        format(round(.y, 2), nsmall = 2),
        " [",
        format(round(.x[, "lower"], 2), nsmall = 2),
        ",",
        format(round(.x[, "upper"], 2), nsmall = 2),
        "]")
      ),
  )
```

```{targets rand_tab, tar_simple = TRUE}
rbind(leaf_inla_rand_effects,
  bm_inla_rand_effects,
  inla_surv_random_effect %>%
    mutate(response = "survival")
  ) %>%
group_by(level) %>%
nest() %>%
mutate(ti = map(data, function (inla_rand_tab) {
    x <- inla_rand_tab %>%
      filter(ci_level == "level:0.95") %>%
      select(-ci_level) %>%
      mutate(
        term = str_remove(term, "Precision for "),
        term = str_replace(term, "the Gaussian observations", "epsilon")
      )
      })) %>%
select(-data) %>%
unnest(cols = ti) %>%
mutate(sd_ci = pmap_chr(list(mean, low, high),
    function(mean, high, low, ndigits) {
      paste0(
        format(mean, digits = ndigits, nsmall = 2),
        " [",
        format(low, digits = ndigits, nsmall = 2),
        ",",
        format(high, digits = ndigits, nsmall = 2),
        "]")
    }, ndigits = 1
  )
)
```

```{targets p-pred-surv-sp}
list(
  tar_target(p_pred_surv,
    surv_data_modelling %>%
      group_by(duration_m, ms, com, watering, species, ter) %>%
      summarise(survival = sum(survival) / n()) %>%
      left_join(date_nb_month) %>%
      mutate(
        com = recode_factor(com, !!!com_replacement()),
        ms = recode_factor(ms, !!!ms_replacement()),
        species = recode_factor(species, !!!species_replacement()),
        watering = recode_factor(watering, !!!water_replacement()),
        ) %>%
      ggplot(aes(y = survival, x = date, shape = com, color = watering)) +
      geom_jitter(alpha = .2) +
      geom_line(
        data = inla_surv_pred %>%
          mutate(
            com = recode_factor(com, !!!com_replacement()),
            ms = recode_factor(ms, !!!ms_replacement()),
            watering = recode_factor(watering, !!!water_replacement()),
            species = recode_factor(species, !!!species_replacement()),
            ) %>%
        left_join(date_nb_month), aes(y = mean)) +
      geom_point(data = inla_surv_pred %>%
          mutate(
            com = recode_factor(com, !!!com_replacement()),
            ms = recode_factor(ms, !!!ms_replacement()),
            watering = recode_factor(watering, !!!water_replacement()),
            species = recode_factor(species, !!!species_replacement()),
            ) %>%
        left_join(date_nb_month), aes(y = mean)) +
      facet_grid(cols = vars(species), rows = vars(ms)) +
      scale_x_date(date_labels = "%b", breaks = date_nb_month$date) +
      scale_color_manual(values = wet_dry_color()) +
      scale_fill_manual(values = wet_dry_color()) +
      labs(
        x = "Month",
        y = "Probability of survival",
        color = "Watering",
        shape = "Diversity") +
      theme_bw() +
      theme(legend.position = "bottom")
    ),
  tar_target(p_pred_sp_surv,
    surv_data_modelling %>%
      group_by(duration_m, ms, com, watering, species, ter) %>%
      summarise(survival = sum(survival) / n()) %>%
      left_join(date_nb_month) %>%
      mutate(
        com = recode_factor(com, !!!com_replacement()),
        ms = recode_factor(ms, !!!ms_replacement()),
        species = recode_factor(species, !!!species_replacement()),
        watering = recode_factor(watering, !!!water_replacement()),
        ) %>%
      ggplot(aes(y = survival, x = date, shape = com, color = watering)) +
      geom_jitter(alpha = .2) +
      geom_line(data = inla_surv_sp_pred %>%
          mutate(
            com = recode_factor(com, !!!com_replacement()),
            ms = recode_factor(ms, !!!ms_replacement()),
            species = recode_factor(species, !!!species_replacement()),
            ) %>%
        left_join(date_nb_month), aes(y = mean)) +
      geom_point(data = inla_surv_sp_pred %>%
          mutate(
            com = recode_factor(com, !!!com_replacement()),
            ms = recode_factor(ms, !!!ms_replacement()),
            species = recode_factor(species, !!!species_replacement()),
            ) %>%
        left_join(date_nb_month), aes(y = mean)) +
      facet_grid(cols = vars(species), rows = vars(ms)) +
      scale_x_date(date_labels = "%b", breaks = date_nb_month$date) +
      scale_color_manual(values = wet_dry_color()) +
      scale_fill_manual(values = wet_dry_color()) +
      labs(
        x = "Month",
        y = "Probability of survival",
        color = "Watering",
        shape = "Diversity") +
      theme_bw() +
      theme(legend.position = "bottom")
  )
)
```

```{targets}
list(
  tar_target(p_pred_bm, surv_data_modelling %>%
    group_by(duration_m, ms, com, watering, species, plot) %>%
    summarise(bm = mean(bm, na.rm = TRUE)) %>%
    left_join(date_nb_month) %>%
    mutate(
      com = recode_factor(com, !!!com_replacement()),
      ms = recode_factor(ms, !!!ms_replacement()),
      species = recode_factor(species, !!!species_replacement()),
      ) %>%
    ggplot(aes(y = bm, x = date, color = com, shape = watering)) +
    geom_jitter(alpha = .2) +
    geom_line(data = bm_inla_sp_pred %>%
      filter(response == "bm") %>%
      mutate(
        com = recode_factor(com, !!!com_replacement()),
        ms = recode_factor(ms, !!!ms_replacement()),
        species = recode_factor(species, !!!species_replacement()),
        ) %>%
      left_join(date_nb_month), aes(y = mean)) +
    geom_point(data = bm_inla_sp_pred %>%
      filter(response == "bm") %>%
      mutate(
        com = recode_factor(com, !!!com_replacement()),
        ms = recode_factor(ms, !!!ms_replacement()),
        species = recode_factor(species, !!!species_replacement()),
        ) %>%
      left_join(date_nb_month), aes(y = mean)) +
    facet_grid(cols = vars(species), rows = vars(ms)) +
    scale_x_date(date_labels = "%b", breaks = date_nb_month$date) +
    labs(
      x = "Month",
      y = "Biomass",
      color = "Diversity",
      shape = "Watering") +
    theme_bw() +
    theme(legend.position = "bottom")
  )

)
```

```{targets}
list(
  tar_target(p_effect_trait,
    plot_inla_fixed_effect(
      leaf_inla_effects_scaled %>%
        mutate(response = toupper(response)),
      term_to_rm = term2rm) +
    labs(x = "Standardised coefficients", color = "Leaf trait") +
    scale_color_manual(values = trait_color()) +
    theme(
      legend.position = "bottom",
      legend.justification = c("right", "bottom"),
      axis.title.y = element_blank()
    )
  )

)
```

```{targets}
list(
  tar_target(partition_pred_bm,
    bm_inla_pred_samp %>%
      filter(response == "bm", level == "community") %>%
      unnest(cols = c(samp)) %>%
      pivot_wider(names_from = "com", values_from = "value") %>%
      mutate(
        obs_rel_yield =  Poly / Mono,
        mono = Mono
        ) %>%
      pivot_longer(c(Poly, Mono), names_to = "com", values_to = "mean") %>%
      mutate(
        richness = ifelse(com == "Mono", 1, 3),
        #RYE;i à expected relative yield of species i in the mixture, which is
        #simply its proportion seeded or planted
        exp_rel_yield = 1 / richness,
        #YE;i à RYE;iMi à expected yield of species i in the mixture
        exp_yield = exp_rel_yield * mono,
        #DRYi à RYO;i 2 RYE;i à deviation from expected relative yield of species i
        #in the mixture
        dev_exp_yield = obs_rel_yield - exp_rel_yield
        ) %>%
      filter(richness != 1) %>%
      group_by(ms, watering, duration_m, rep) %>%
      summarise(
        # Total obs yield - expected
        net = sum(mean) - sum(exp_yield),
        selection = unique(richness) * cov(dev_exp_yield, mono),
        complementarity = unique(richness) * mean(dev_exp_yield) * mean(mono),
        .groups = "drop"
      )
    ),
  tar_target(partition_pred_bm_ci, partition_pred_bm %>%
    pivot_longer(
      c(net, selection, complementarity),
      names_to = "div", values_to = "values") %>%
    group_by(duration_m, ms, watering, div) %>%
    summarise(
      mean = mean(values),
      hpd = list(
        tibble(
          lower = coda::HPDinterval(coda::as.mcmc(values), prob = .80)[1],
          upper = coda::HPDinterval(coda::as.mcmc(values), prob = .80)[2]
        )
        ),
      .groups = "drop"
      ) %>%
    unnest()
  )

)
```


```{targets}
list(
  tar_target(bm_inla_sp_pred_sampling, {
    inla_bm_sp <- bm_inla_sp %>%
      filter(response == "bm") %>%
      select(mod)
    mod_sp <- inla_bm_sp$mod[[1]]
    cbind(
      pred_surv_data[, c("duration_m", "ms", "com", "watering", "species")],
      tibble(
        fitted = mod_sp$marginals.fitted.values[(nrow(surv_data_modelling) + 1):length(mod_sp$marginals.fitted.values)])
      ) %>%
    as_tibble() %>%
    mutate(
      sampling = map(fitted,
        ~tibble(value = inla.rmarginal(1000, .x), rep = 1:length(value))
      )
      ) %>%
    select(-fitted) %>%
    unnest(sampling)
    }
    ),
  tar_target(partition_pred_bm_sp, bm_inla_sp_pred_sampling %>%
    pivot_wider(names_from = "com", values_from = "value") %>%
    mutate(
      obs_rel_yield =  Poly / Mono,
      mono = Mono
      ) %>%
    pivot_longer(c(Poly, Mono), names_to = "com", values_to = "mean") %>%
    mutate(
      richness = ifelse(com == "Mono", 1, 3),
      #RYE;i à expected relative yield of species i in the mixture, which is
      #simply its proportion seeded or planted
      exp_rel_yield = 1 / richness,
      #YE;i à RYE;iMi à expected yield of species i in the mixture
      exp_yield = exp_rel_yield * mono,
      #DRYi à RYO;i 2 RYE;i à deviation from expected relative yield of species i
      #in the mixture
      dev_exp_yield = obs_rel_yield - exp_rel_yield
      ) %>%
    filter(richness != 1) %>%
    group_by(ms, watering, duration_m, rep) %>%
    summarise(
      # Total obs yield - expected
      net = sum(mean) - sum(exp_yield),
      selection = unique(richness) * cov(dev_exp_yield, mono),
      complementarity = unique(richness) * mean(dev_exp_yield) * mean(mono),
      .groups = "drop"
      )),
  tar_target(partition_pred_bm_sp_ci, partition_pred_bm_sp %>%
    pivot_longer(
      c(net, selection, complementarity),
      names_to = "div", values_to = "values") %>%
    group_by(duration_m, ms, watering, div) %>%
    summarise(
      mean = mean(values),
      hpd = list(
        tibble(
          lower = coda::HPDinterval(coda::as.mcmc(values), prob = .80)[1],
          upper = coda::HPDinterval(coda::as.mcmc(values), prob = .80)[2]
        )
        ),
      .groups = "drop"
      ) %>%
    unnest()
  )
)
```

```{targets}
list(
  tar_target(p_partition_pred_bm_ci, partition_pred_bm_ci %>%
  mutate(
    metric = recode_factor(div, !!!div_eff_replacement()),
    ms = recode_factor(ms, !!!ms_replacement()),
    watering = recode_factor(watering, !!!water_replacement()),
  ) %>%
  left_join(date_nb_month) %>%
  ggplot(aes(y = mean, x = date, color = watering, shape = ms)) +
  geom_point(size = 3) +
  geom_line() +
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = watering), alpha = .1,
    color = NA) +
  facet_wrap(~metric, scales = "free_y") +
  scale_x_date(date_labels = "%b", breaks = date_nb_month$date) +
  scale_color_manual(values = wet_dry_color()) +
  scale_fill_manual(values = wet_dry_color()) +
  labs(
    x = "Month",
    y = "Diversity effect (Biomass)",
    shape = "Microsite",
    color = "Watering", fill = "Watering") +
  theme_bw() +
  theme(legend.position = "bottom")
    ),
  tar_target(p_partition_pred_bm_sp_ci,
    partition_pred_bm_sp_ci %>%
      mutate(
        metric = recode_factor(div, !!!div_eff_replacement()),
        ms = recode_factor(ms, !!!ms_replacement()),
        watering = recode_factor(watering, !!!water_replacement()),
        ) %>%
    left_join(date_nb_month) %>%
    ggplot(aes(y = mean, x = date, color = watering, shape = ms)) +
    geom_point(size = 3) +
    geom_line() +
    geom_ribbon(aes(ymin = lower, ymax = upper, fill = watering), alpha = .2,
      color = NA) +
    facet_wrap(~metric, scales = "free_y") +
    scale_x_date(date_labels = "%b", breaks = date_nb_month$date) +
    scale_color_manual(values = wet_dry_color()) +
    scale_fill_manual(values = wet_dry_color()) +
    labs(
      x = "Month",
      y = "Diversity effect (Biomass)",
      shape = "Microsite",
      color = "Watering", fill = "Watering") +
    theme_bw() +
    theme(legend.position = "bottom")
  )
)
```


# Pipeline

If you ran all the `{targets}` chunks in non-interactive mode, then your R scripts are set up to run the pipeline.

```{r tar-make}
tar_make(envir = parent.frame())
```

# Output

```{r}
library(targets)
library(tidyverse)
library(magrittr)
library(here)
library(zoo)
library(moments)
library(cowplot)
source(here::here("R","basic_stat.R"))
source(here::here("R","inla_helpers.R"))
source(here::here("R","clean_data.R"))
source(here::here("R","string_replacements.R"))
source(here::here("R","plot.r"))
Sys.setlocale("LC_ALL", "en_GB.utf8")
```

```{r}
tar_load(c(p_surv_pp_ci, p_bm_pp_ci))
p_surv_pp_ci +
  scale_color_manual(values = wet_dry_color()) +
  scale_fill_manual(values = wet_dry_color())
```


```{r}
tar_load(c(fig2, p_surv_pp_ci, p_bm_pp_ci))
ggsave_multiple(
  paste0("fig2", c(".png", ".pdf")),
  plot = fig2,
  path = here("paper", "graphics"),
  scale = 2.4,
  width = 80,
  height = 80 * .9,
  units = "mm",
  dpi = 400)
```


## Complementarity and selection effects

```{r}
ggsave(
  filename = "p_partition_pred_bm_ci.png",
  plot = tar_read(p_partition_pred_bm_ci),
  path = here("paper", "graphics"),
  scale = 1.8,
  width = 90,
  height = 90 * .6,
  units = "mm",
  dpi = "print"
)
```

```{r}
tar_load(c(p_effect_trait, p_partition_pred_bm_sp_ci))
fig3 <- plot_grid(
  plot_grid(p_effect_trait, NULL, rel_widths = c(1, 1)),
  p_partition_pred_bm_sp_ci,
  rel_heights = c(1, 1.2),
  nrow = 2,
  labels = "auto"
)
fig3 <- plot_grid(
  p_effect_trait,
  p_partition_pred_bm_sp_ci,
  rel_widths = c(.4, 1),
  nrow = 1,
  labels = "auto"
    )
ggsave_multiple(
  paste0("fig3", c(".png", ".pdf")),
  plot = fig3,
  path = here("paper", "graphics"),
  scale = 2.6,
  width = 80,
  height = 80 * .45,
  units = "mm",
  dpi = 400)
```

```{r}
fig3_alt <- p_effect_trait +
  theme(legend.justification = c("center", "bottom"))
ggsave_multiple(
  paste0("fig3_alt", c(".png", ".pdf")),
  plot = fig3_alt,
  path = here("paper", "graphics"),
  scale = 1.2,
  width = 80,
  height = 80 * 1.05,
  units = "mm",
  dpi = 400)
```

```{r}
ggsave_multiple(
  paste0("fig4", c(".png", ".pdf")),
  plot = tar_read(p_partition_pred_bm_sp_ci),
  path = here("paper", "graphics"),
  scale = 2.6,
  width = 80,
  height = 80 * .40,
  units = "mm",
  dpi = 400)
```



```{r}
tar_load(c(p_int_global_surv, p_int_global_bm))
fig_effect_int <- plot_grid(
  plot_grid(
    p_surv,
    p_bm,
    labels = c("a", "b")
    ),
  plot_grid(
    p_int_global_surv + theme(legend.position = "none"),
    p_int_global_bm + theme(legend.position = "none"),
    labels = c("c", "d")
    ),
  get_legend(p_int_global_bm + theme(legend.position = "bottom")),
  rel_heights = c(1.2, 1.0, .1),
  nrow = 3
)

ggsave(
  filename = "p_surv_bm_int.pdf",
  plot = fig_effect_int,
  path = here("paper", "graphics"),
  scale = 2.4,
  width = 100,
  height = 100 * .8,
  units = "mm",
  dpi = "print"
)
ggsave(
  filename = "p_surv_bm_int.png",
  plot = fig_effect_int,
  path = here("paper", "graphics"),
  scale = 2.4,
  width = 100,
  height = 100 * .8,
  units = "mm",
  dpi = "print"
)
```

```{r}
ggsave(
  filename = "p_bm_int.pdf",
  plot = plot_grid(p_bm, p_int_global_bm),
  path = here("paper", "graphics"),
  scale = 2.4,
  width = 90,
  height = 90 * .6,
  units = "mm",
  dpi = "print"
)
ggsave(
  filename = "p_bm_int.pdf",
  plot = plot_grid(p_surv, p_int_global_surv),
  path = here("paper", "graphics"),
  scale = 2.4,
  width = 90,
  height = 90 * .6,
  units = "mm",
  dpi = "print"
)
```

```{r}
ggsave(
  filename = "p_surv_int.pdf",
  plot = plot_grid(p_surv, p_int_global_surv),
  path = here("paper", "graphics"),
  scale = 2.4,
  width = 90,
  height = 90 * .6,
  units = "mm",
  dpi = "print"
)
ggsave(
  filename = "p_surv_int.png",
  plot = plot_grid(p_surv, p_int_global_surv),
  path = here("paper", "graphics"),
  scale = 2.4,
  width = 90,
  height = 90 * .6,
  units = "mm",
  dpi = "print"
)
```

```{r}
leg_pred <- get_legend(p_pred_surv)
p_pred_effect <- plot_grid(
  plot_grid(
    p_surv,
    p_pred_surv + theme(
      legend.position = "none",
      axis.text.x = element_text(angle = 20, hjust = 1)
      ),
    rel_widths = c(.5, 1), labels = c("a", "b")),
  plot_grid(p_bm, p_pred_bm + theme(
      legend.position = "none",        #
      axis.text.x = element_text(angle = 20, hjust = 1)
      ),
    rel_widths = c(.5, 1), labels = c("c", "d")),
  leg_pred,
  rel_heights = c(1, 1, .1),
  ncol = 1)
ggsave(
  filename = "p_pred_effect.pdf",
  plot = p_pred_effect,
  path = here("paper", "graphics"),
  scale = 2.4,
  width = 100,
  height = 100,
  units = "mm",
  dpi = "print"
)
ggsave(
  filename = "p_pred_effect.png",
  plot = p_pred_effect,
  path = here("paper", "graphics"),
  scale = 2.4,
  width = 90,
  height = 90,
  units = "mm",
  dpi = "print"
)
```



```{r}
tar_load(pp_int)
int_surv <- pp_int %>%
  filter(response %in% c("survival"))
p_int_surv <- int_surv  %>%
  ggplot(aes(y = inta, x = duration_m + 6, color = com, shape = watering, fill = com), alpha = 1) +
  geom_line() +
  geom_point() +
  geom_hline(yintercept = 0) +
  geom_ribbon(aes(ymin = inta_low, ymax = inta_high), alpha = .2, color = NA) +
  facet_grid(cols = vars(species), scales = "free_y") +
  labs(
    y = "Net interaction (survival)",
    x = "Number of month since the beginning of the experiment") +
  theme_bw()

p_int_bm <- pp_int %>%
  filter(duration_m == 5, response == "bm") %>%
  ggplot(
    aes(
      y = inta, ymin = inta_low, ymax = inta_high,
      x = species, color = com, shape = watering,
      group = watering,
      fill = com
      ),
    alpha = 1, position = "dodge") +
  geom_hline(yintercept = 0) +
  geom_pointrange(position = position_dodge(.5)) +
  labs(
    y = "Net interaction (biomass)",
    shape = "Watering", color = "Diversity"
    ) +
  theme_bw() +
  theme(
    axis.title.x = element_blank(),
    legend.position = "bottom"
  )
leg_int <- get_legend(p_int_bm)

p_int_sp <- plot_grid(
  p_int_surv + theme(legend.position = "none"),
  p_int_bm + theme(legend.position = "none"),
  rel_widths = c(.6, .4),
  labels = c("c", "d")
)
```

```{r}
tar_load(p_int_global)
p_int <- plot_grid(
  p_int_global + theme(legend.position = "none"),
  p_int_sp,
  nrow = 2
)
p_int_ok <- plot_grid(
  p_int,
  leg_int,
  rel_heights = c(1, .1),
  nrow = 2
)
ggsave(
  filename = "p_int_ok.pdf",
  plot = p_int_ok,
  path = here("paper", "graphics"),
  scale = 2.4,
  width = 90,
  height = 90 * .6,
  units = "mm",
  dpi = "print"
)
ggsave(
  filename = "p_int_ok.png",
  plot = p_int_ok,
  path = here("paper", "graphics"),
  scale = 2.4,
  width = 90,
  height = 90 * .6,
  units = "mm",
  dpi = "print"
)
```

```{r, fig.cap = "Leaf traits"}
tar_load(c(leaf_inla_sp_pred, leaf_trait_modelling,
    leaf_inla_effects_scaled, term2rm, p_effect_trait))


ggsave(
  filename = "p_effect_trait.pdf",
  plot = p_effect_trait,
  path = here("paper", "graphics"),
  scale = 1.8,
  width = 90,
  height = 90,
  units = "mm",
  dpi = "print"
)
ggsave(
  filename = "p_effect_trait.png",
  plot = p_effect_trait,
  path = here("paper", "graphics"),
  scale = 1.8,
  width = 90,
  height = 90,
  units = "mm",
  dpi = "print"
)
```

```{r}
p_pred_leaf <- leaf_trait_modelling %>%
  pivot_longer(c(ldmc, sla), names_to = "trait", values_to = "values") %>%
  mutate(
    com = recode_factor(com, !!!com_replacement()),
    ms = recode_factor(ms, !!!ms_replacement()),
    species = recode_factor(species, !!!species_replacement()),
    watering = recode_factor(watering, !!!water_replacement()),
    trait = str_to_upper(trait)
    ) %>%
  group_by(ms, com, watering, trait, species, ter) %>%
  summarise(n = sum(!is.na(values)), values = mean(values, na.rm = TRUE)) %>%
  filter(n >= 3) %>%
  ggplot(aes(y = values, x = ms, color = watering, shape = com)) +
  geom_jitter(alpha = .2) +
  geom_point(
    data = leaf_inla_sp_pred %>%
      rename(trait = response) %>%
      mutate(
        com = recode_factor(com, !!!com_replacement()),
        ms = recode_factor(ms, !!!ms_replacement()),
        species = recode_factor(species, !!!species_replacement()),
        trait = str_to_upper(trait)
      ), aes(y = mean), size = 2) +
  facet_grid(cols = vars(species), rows = vars(trait), scales = "free_y") +
  scale_color_manual(values = wet_dry_color()) +
  scale_fill_manual(values = wet_dry_color()) +
  labs(
    x = "",
    y = "Leaf trait values",
    color = "Watering",
    shape = "Diversity") +
  theme_bw() +
  theme(legend.position = "bottom")
ggsave(
  filename = "p_pred_leaf.pdf",
  plot = p_pred_leaf,
  path = here("paper", "graphics"),
  scale = 1.8,
  width = 90,
  height = 90 * .6,
  units = "mm",
  dpi = "print"
)
```

```{r}
p_leaf <- plot_grid(p_effect_trait, p_pred_leaf, ncol = 2, rel_widths = c(.4, 1), labels = "auto")
ggsave(
  filename = "p_leaf.pdf",
  plot = p_leaf,
  path = here("paper", "graphics"),
  scale = 2.4,
  width = 90,
  height = 90 * .55,
  units = "mm",
  dpi = "print"
)
ggsave(
  filename = "p_leaf.png",
  plot = p_leaf,
  path = here("paper", "graphics"),
  scale = 2.4,
  width = 90,
  height = 90 * .55,
  units = "mm",
  dpi = "print"
)
```

```{r, fig.cap = "Leaf traits"}
tar_load(c(env_inla_effects_scaled, env_data_modelling_scaled))

p_effect_env <- plot_inla_fixed_effect(
  env_inla_effects_scaled %>%
    mutate(response = response_replacement()[response]),
  term_to_rm = term2rm) +
  labs(x = "Standardized coefficients", color = "Environmental variable") +
  viridis::scale_color_viridis(discrete = T) +
  theme(
    legend.position = "bottom",
    axis.title.y = element_blank()
  )

ggsave(
  filename = "p_effect_env.pdf",
  plot = p_effect_env,
  path = here("paper", "graphics"),
  scale = 1.8,
  width = 90,
  height = 90,
  units = "mm",
  dpi = "print"
)
ggsave(
  filename = "p_effect_env.png",
  plot = p_effect_env,
  path = here("paper", "graphics"),
  scale = 1.8,
  width = 90,
  height = 90,
  units = "mm",
  dpi = "print"
)
```

```{r}
tar_load(c(env_inla_pred, env_data_modelling))
env_data_modelling %>%
  pivot_longer(c(soil.moisture, temperature, PAR), names_to = "response",
    values_to = "values") %>%
  group_by(response, duration_m, ms, watering, ter) %>%
  summarise(values = mean(values, na.rm = TRUE)) %>%
  mutate(
    watering = recode_factor(watering, !!!water_replacement()),
  ) %>%
  ggplot(aes(y = values, x = duration_m, color = watering, shape = ms)) +
  geom_point(alpha = .4) +
  geom_line(data = env_inla_pred, aes(y = mean)) +
  geom_point(data = env_inla_pred, aes(y = mean)) +
  geom_ribbon(data = env_inla_pred, aes(y = mean, ymin = `0.025quant`, ymax = `0.975quant`, fill = watering), alpha = .2, color = NA) +
  facet_grid(rows = vars(response), scales = "free_y") +
  scale_color_manual(values = wet_dry_color()) +
  scale_fill_manual(values = wet_dry_color()) +
  labs(
    x = "Number of month since the start of the experiment",
    y = "Environmental values",
    shape = "Microsite",
    fill = "Watering",
    color = "Watering") +
  theme_bw() +
  theme(legend.position = "bottom")
```

```{r}
env_inla_pred %>%
  filter(duration_m == 5)
```

# Supplementary

## Environmental variables

```{r}
tar_load(env_plot)
ggsave_multiple(
  paste0("p_env_raw_data", c(".png", ".pdf")),
  plot = env_plot + theme(legend.position = "bottom"),
  path = here("paper", "graphics"),
  scale = 2.4,
  dpi = 400,
  width = 80,
  height = 80 * .5,
  units = "mm")
```

## Biomass allometry

```{r}
tar_load(c(biomass_t0, biomass_modelling))
biomass_t0$bm_total_pred <- exp(predict(biomass_modelling$log_mod_bm_tot_h))
p_pred_bm <- biomass_t0 %>%
  mutate(
    species = recode_factor(species, !!!species_replacement())
  ) %>%
  ggplot(aes(x = bm_total, y = bm_total_pred, color = species)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  labs(
    y = "Predicted total biomass",
    x = "Observed total biomass",
    color = "Species"
    ) +
  theme_bw() +
  theme(legend.position = "bottom")

ggsave_multiple(
  paste0("p_pred_bm", c(".png", ".pdf")),
  plot = p_pred_bm,
  path = here("paper", "graphics"),
  scale = 2.0,
  dpi = 400,
  width = 80,
  height = 80 * 1,
  units = "mm")
```

# Sensibility to biomass metric

```{r}
tar_load(bm_inla_scaled_effects)
ti <- bm_inla_scaled_effects %>%
  filter(response %in% c("d", "bm", "h")) %>%
  mutate(response = response_replacement()[response])
p_bm_d_effect <- plot_inla_fixed_effect(ti,
  color_var = response,
  intercept = 0,
  term_to_rm = c(tar_read(term2rm), "duration_m", "I(duration_m^2)")
  ) +
  labs(x = "Standardised coefficients", color = "Variable") +
  theme(
    axis.title.y = element_blank(),
    legend.position = "bottom"
  )
ggsave(
  filename = "p_bm_d_effect.pdf",
  plot = p_bm_d_effect,
  path = here("paper", "graphics"),
  scale = 1.8,
  width = 80,
  height = 80 * 1,
  units = "mm",
  dpi = 400
)
```


## Prediction and raw data

```{r}
tar_load(p_pred_surv)
tar_load(c(surv_data_modelling, bm_inla_pred))
p_pred_bm_ok <- surv_data_modelling %>%
  group_by(duration_m, ms, com, watering, species, ter) %>%
  summarise(bm = mean(bm, na.rm = TRUE)) %>%
  left_join(date_nb_month) %>%
  mutate(
    com = recode_factor(com, !!!com_replacement()),
    ms = recode_factor(ms, !!!ms_replacement()),
    species = recode_factor(species, !!!species_replacement()),
    watering = recode_factor(watering, !!!water_replacement()),
  ) %>%
  ggplot(aes(y = bm, x = date, shape = com, color = watering)) +
  geom_jitter(alpha = .2) +
  geom_line(data = bm_inla_pred %>% filter(response == "bm") %>%
  left_join(date_nb_month) %>%
  mutate(
    com = recode_factor(com, !!!com_replacement()),
    ms = recode_factor(ms, !!!ms_replacement()),
    species = recode_factor(species, !!!species_replacement()),
    watering = recode_factor(watering, !!!water_replacement()),
  ), aes(y = mean)) +
  geom_point(data = bm_inla_pred %>% filter(response == "bm") %>%
  left_join(date_nb_month) %>%
  mutate(
    com = recode_factor(com, !!!com_replacement()),
    ms = recode_factor(ms, !!!ms_replacement()),
    species = recode_factor(species, !!!species_replacement()),
    watering = recode_factor(watering, !!!water_replacement()),
  ), aes(y = mean)) +
  facet_grid(cols = vars(species), rows = vars(ms)) +
  scale_x_date(date_labels = "%b", breaks = date_nb_month$date) +
  scale_color_manual(values = wet_dry_color()) +
  labs(
    x = "Month",
    y = "Biomass",
    color = "Watering",
    shape = "Diversity") +
  theme_bw() +
  theme(legend.position = "bottom")

p_pred_surv_bm <- plot_grid(
  p_pred_surv + theme(legend.position = "none"),
  p_pred_bm_ok + theme(legend.position = "none"),
  get_legend(p_pred_bm_ok),
  nrow = 3,
  rel_heights = c(1, 1, .1),
  labels = c("a", "b", "")
)
ggsave_multiple(
  paste0("p_pred_surv_bm", c(".png", ".pdf")),
  plot = p_pred_surv_bm,
  path = here("paper", "graphics"),
  scale = 2.4,
  dpi = 400,
  width = 80,
  height = 80 * 1.2,
  units = "mm")
```

- Leaf traits:

```{r}
tar_load(c(leaf_trait_modelling, leaf_inla_pred))
p_pred_leaf <- leaf_trait_modelling %>%
  pivot_longer(c(ldmc, sla), names_to = "trait", values_to = "values") %>%
  mutate(
    trait = str_to_upper(trait),
    com = recode_factor(com, !!!com_replacement()),
    ms = recode_factor(ms, !!!ms_replacement()),
    species = recode_factor(species, !!!species_replacement()),
    watering = recode_factor(watering, !!!water_replacement()),
    ) %>%
  group_by(ms, com, watering, trait, species, ter) %>%
  summarise(n = sum(!is.na(values)), values = mean(values, na.rm = TRUE)) %>%
  filter(n >= 3) %>%
  ggplot(aes(y = values, x = ms, color = watering, shape = com)) +
  geom_jitter(alpha = .2) +
  geom_point(
    data = leaf_inla_pred %>%
      rename(trait = response) %>%
      mutate(
        trait = str_to_upper(trait),
        com = recode_factor(com, !!!com_replacement()),
        ms = recode_factor(ms, !!!ms_replacement()),
        species = recode_factor(species, !!!species_replacement()),
        watering = recode_factor(watering, !!!water_replacement()),
      ), aes(y = mean), size = 2) +
  facet_grid(cols = vars(species), rows = vars(trait), scales = "free_y") +
  scale_color_manual(values = wet_dry_color()) +
  labs(
    x = "",
    y = "Leaf trait values",
    color = "Watering",
    shape = "Diversity") +
  theme_bw() +
  theme(legend.position = "bottom")
ggsave(
  filename = "p_pred_leaf.pdf",
  plot = p_pred_leaf,
  path = here("paper", "graphics"),
  scale = 2.8,
  width = 80,
  height = 80 * .7,
  units = "mm",
  dpi = "print"
)
```

- Selection and complementarity:

```{r}
tar_load(surv_data_modelling)
avg_bm_sp_rep <- surv_data_modelling %>%
  group_by(ter, com, ms, watering, species, duration_m) %>%
  summarise(avg = mean(bm, na.rm = TRUE))

# Monoculture
mono_rep_sp <- avg_bm_sp_rep %>%
  filter(com == "Mono") %>%
  group_by(ter, ms, watering, species, duration_m) %>%
  summarise(mono = unique(avg), .groups = "drop")

# Compute metrics for diversity effects
ti <- avg_bm_sp_rep %>%
  left_join(mono_rep_sp,
    by = c("ter", "ms", "watering", "species", "duration_m")) %>%
mutate(
  # RYO;i à YO;i=Mi à observed relative yield of species i in the mixture
  obs_rel_yield = avg / mono,
  richness = ifelse(com == "Mono", 1, 3),
  #RYE;i à expected relative yield of species i in the mixture, which is
  #simply its proportion seeded or planted
  exp_rel_yield = 1 / richness,
  #YE;i à RYE;iMi à expected yield of species i in the mixture
  exp_yield = exp_rel_yield * mono,
  #DRYi à RYO;i 2 RYE;i à deviation from expected relative yield of species i
  #in the mixture
  dev_exp_yield = obs_rel_yield - exp_rel_yield
)

div_effects <- ti %>%
  filter(richness != 1) %>%
  group_by(ter, com, ms, watering, duration_m) %>%
  summarise(
    # Total obs yield - expected
    net = sum(avg) - sum(exp_yield),
    selection = unique(richness) * cov(dev_exp_yield, mono),
    complementarity = unique(richness) * mean(dev_exp_yield) * mean(mono),
    .groups = "drop"
  )
div_effects_lg <- div_effects %>%
  pivot_longer(c(net, selection, complementarity),
    names_to = "metric", values_to = "values") %>%
left_join(date_nb_month) %>%
mutate(
  com = recode_factor(com, !!!com_replacement()),
  ms = recode_factor(ms, !!!ms_replacement()),
  watering = recode_factor(watering, !!!water_replacement()),
  metric = recode_factor(metric, !!!div_eff_replacement()),
)

p_data_div_partition <- div_effects_lg %>%
  ggplot(aes(x = ms, y = values, color = watering)) +
  geom_boxplot() +
  facet_wrap(~metric, scales = "free_y") +
  scale_color_manual(values = wet_dry_color()) +
  scale_fill_manual(values = wet_dry_color()) +
  labs(
    x = "Microsite",
    y = "Diversity effect (Biomass)",
    color = "Watering", fill = "Watering") +
  theme_bw() +
  theme(legend.position = "bottom") +
  facet_wrap(~metric, scales = "free_y")

ggsave_multiple(
  paste0("p_data_div_partition", c(".png", ".pdf")),
  plot = p_data_div_partition,
  path = here("paper", "graphics"),
  scale = 2.8,
  width = 80,
  height = 80 * .4,
  units = "mm",
  dpi = 400)
```

```{r}
p_data_div_partition_time <- div_effects_lg %>%
  ggplot(aes(y = values, x = date, color = watering, shape = ms, linetype = ms, group = interaction(date, watering, ms))) +
  geom_boxplot() +
  geom_point(position = position_dodge(.9), alpha = .5) +
  facet_wrap(~metric, scales = "free_y") +
  scale_color_manual(values = wet_dry_color()) +
  scale_x_date(date_labels = "%b", breaks = date_nb_month$date) +
  labs(
    shape = "Microsite",
    linetype = "Microsite",
    x = "Month",
    y = "Diversity effect",
    color = "Watering", fill = "Watering") +
  theme_bw() +
  theme(legend.position = "bottom") +
  facet_wrap(~metric, scales = "free_y")

ggsave_multiple(
  paste0("p_data_div_partition_time", c(".png", ".pdf")),
  plot = p_data_div_partition_time,
  path = here("paper", "graphics"),
  scale = 2.8,
  width = 80,
  height = 80 * .4,
  units = "mm",
  dpi = 400)
```


## Model coefficients not presented in main text

```{r}
tar_load(c(p_other_surv, p_other_bm, p_other_leaf))
p_other <- plot_grid(
  plot_grid(
    p_other_surv,
    p_other_bm,
    p_other_leaf + theme(legend.position = "none"),
    nrow = 1,
    labels = "auto"
    ),
  nrow = 2,
  get_legend(p_other_leaf + theme(legend.position = "bottom")),
  rel_heights = c(1, .1)
)
ggsave(
  filename = "p_other_effect.pdf",
  plot = p_other,
  path = here("paper", "graphics"),
  scale = 3.2,
  width = 80,
  height = 80 * .4,
  units = "mm",
  dpi = "print"
)
```


The `targets` dependency graph helps your readers understand the steps of your pipeline at a high level.

```{r}
tar_visnetwork()
```

At this point, you can go back and run `{targets}` chunks in interactive mode
without interfering with the code or data of the non-interactive pipeline.

