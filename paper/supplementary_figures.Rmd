---
title: "Supplementary information"
subtitle: ""
author: ""
date: ""
output:
  bookdown::pdf_document2:
    latex_engine: xelatex
    keep_tex: true
    spacing: double
    number_sections: false
  officedown::rdocx_document:
bibliography: "bibliography.bib"
link-citations: true
toc: false
linestretch: 2.0
header-includes:
  - \usepackage{float}
  - \renewcommand{\thefigure}{S\arabic{figure}}
  - \renewcommand{\thetable}{S\arabic{table}}
---

```{r setup, include=FALSE}
library(rmarkdown)
library(officedown)
knitr::opts_chunk$set(echo = FALSE,
                      collapse = TRUE,
                      message = FALSE,
                      warning = FALSE,
                      comment = "#>",
                      fig.path = "graphics/knitr-",
                      fig.retina = 1.618, # Control using dpi
                      fig.width = 6,  # generated images
                      fig.pos = "H",  # pdf mode
                      #fig.align = "center",
                      dpi = if (knitr::is_latex_output()) 72 else 300,
                      out.width = "100%",
                      dev = "png",
                      dev.args = list(png = list(type = "cairo-png")),
                      optipng = "-o1 -quiet")

library(here)
source(here::here("R","basic_stat.R"))
source(here::here("R","inla_helpers.R"))
source(here::here("R","clean_data.R"))
source(here::here("R","string_replacements.R"))
library(tidyverse)
library(magrittr)
library(cowplot)
library(targets)
library(kableExtra)
library(coda)
library(ggbreak)

if (Sys.info()["login"] == "alain") {
  file.copy(
    from = "~/Documents/post-these/references.bib",
    to = here("paper", "bibliography.bib"),
    overwrite = TRUE
  )
}
```

# Figures

```{r}
tar_load(biomass_modelling)
tar_load(biomass_modelling_r2)
tar_load(biomass_t0)
tar_load(surv_data_modelling)
```

```{r, eval = FALSE}
biomass_t0 %>%
  ggplot(aes(y = log(bm_total), x = log_d, color = species)) +
  geom_point() +
  geom_smooth(method = "lm")
biomass_t0 %>%
  ggplot(aes(y = log(bm_total), x = log_h, color = species)) +
  geom_point() +
  geom_smooth(method = "lm")
surv_data_modelling %>%
  select(duration_m, species, d, h) %>%
  rbind(biomass_t0 %>% select(duration_m, species, d, h)) %>%
  pivot_longer(c(d, h), names_to = "variable", values_to = "values") %>%
  mutate(type = ifelse(duration_m == 0, "laboratory", "field")) %>%
  ggplot(aes(x = values, color = type)) +
  geom_density() +
  facet_wrap(variable ~ species, scales = "free")
```

```{r}
bm_pred_cap <- "Predicted vs observed total biomass. The measurement were done
at the begining of the experiment (See methods, N = 12 individuals per species)." %>%
str_replace_all("\\s+", " ")
```


```{r bm-pred, fig.cap = bm_pred_cap}
biomass_t0$bm_total_pred <- exp(predict(biomass_modelling$log_mod_bm_tot_h))
p_pred_bm <- biomass_t0 %>%
  ggplot(aes(x = bm_total, y = bm_total_pred, color = species)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  labs(y = "Predicted total biomass", x = "Observed total biomass") +
  theme_bw() +
  theme(legend.position = "bottom")
ggsave(
  filename = "p_pred_bm.pdf",
  plot = p_pred_bm,
  path = here("paper", "graphics"),
  scale = 1.4,
  width = 90,
  height = 90 * 1,
  units = "mm",
  dpi = "print"
)
knitr::include_graphics(here("paper", "graphics", "p_pred_bm.pdf"))
```

```{r}
bm_d_effect <- "Coefficients of the statistical models comparing the effects for
total biomass, basal diameter, and vegetative height (the last two being used to
  predict total biomass, see methods). The coefficients for total biomass and
basal diameter models are highly similar."
```


```{r, fig.cap=bm_d_effect}
tar_load(bm_inla_scaled_effects)
ti <- bm_inla_scaled_effects %>%
  filter(response %in% c("d", "bm", "h")) %>%
  mutate(response = response_replacement()[response])
p_bm_d_effect <- plot_inla_fixed_effect(ti,
  color_var = response, intercept = 0) +
  labs(x = "Standardized coefficients", color = "Variable") +
  theme(
    axis.title.y = element_blank(),
    legend.position = "bottom"
  )
ggsave(
  filename = "p_bm_d_effect.pdf",
  plot = p_bm_d_effect,
  path = here("paper", "graphics"),
  scale = 2.4,
  width = 90,
  height = 90 * 1,
  units = "mm",
  dpi = "print"
)
knitr::include_graphics(here("paper", "graphics", "p_bm_d_effect.pdf"))
```

```{r}
obs_fit_cap <- "Observed versus fitted values from the statistical models for (a) survival, (b) total biomass, (c) LDMC and (d) SLA." %>%
str_replace_all("\\s+", " ")
```

```{r obs-fit, fig.cap = obs_fit_cap}
knitr::include_graphics(here("paper", "graphics", "p_obs_fit_tot.png"))
```

```{r}
obs_fit_sp_cap <- "Observed versus fitted values from the statistical models at the
species level for (a) survival, (b) total biomass, (c) LDMC and (d) SLA." %>%
str_replace_all("\\s+", " ")
```

```{r obs-fit-sp, eval = FALSE, fig.cap =obs_fit_sp_cap}
knitr::include_graphics(here("paper", "graphics", "p_obs_fit_sp_tot.png"))
```


```{r}
predicted_surv_cap <- "Predictions of survival (a) and biomass (b) of beneficiary
plants from the statistical models. Shaded points display the raw data
averaged by terrace (N = 3 for each treatment)." %>%
str_replace_all("\\s+", " ")
```

```{r}
tar_load(p_pred_surv)
tar_load(c(surv_data_modelling, bm_inla_pred))
p_pred_bm_ok <- surv_data_modelling %>%
  group_by(duration_m, ms, com, watering, species, ter) %>%
  summarise(bm = mean(bm, na.rm = TRUE)) %>%
  ggplot(aes(y = bm, x = duration_m + 5, shape = com, color = watering)) +
  geom_jitter(alpha = .2) +
  geom_line(data = bm_inla_pred %>% filter(response == "bm"), aes(y = mean)) +
  geom_point(data = bm_inla_pred %>% filter(response == "bm"), aes(y = mean)) +
  facet_grid(cols = vars(species), rows = vars(ms)) +
  labs(
    x = "Number of month since the start of the experiment",
    y = "Biomass of beneficiary",
    color = "Watering",
    shape = "Diversity") +
  theme_bw() +
  theme(legend.position = "bottom")
```

```{r}
p_pred_surv_bm <- plot_grid(
  p_pred_surv + theme(legend.position = "none"),
  p_pred_bm_ok,
  nrow = 2,
  labels = "auto")
ggsave(
  filename = "p_pred_surv_bm.pdf",
  plot = p_pred_surv_bm,
  path = here("paper", "graphics"),
  scale = 2.4,
  width = 140,
  height = 140 * 1,
  units = "mm",
  dpi = "print"
)
```

```{r, fig.cap = predicted_surv_cap}
knitr::include_graphics(here("paper", "graphics", "p_pred_surv_bm.pdf"))
```

```{r}
tar_load(c(p_other_surv, p_other_bm, p_other_leaf))
p_other <- plot_grid(
  p_other_surv, p_other_bm, p_other_leaf,
  nrow = 2,
  labels = "auto",
  rel_heights = c(.7, 1))
ggsave(
  filename = "p_other_effect.pdf",
  plot = p_other,
  path = here("paper", "graphics"),
  scale = 2.4,
  width = 90,
  height = 90 * 1,
  units = "mm",
  dpi = "print"
)
```

```{r}
effect_control_var <- "Model coefficients for the control predictors (species
identity, terrace effect) and intercept for (a) survival, (b) biomass, (c) leaf
traits."
```


```{r, fig.cap = effect_control_var}
knitr::include_graphics(here("paper", "graphics", "p_other_effect.pdf"))
```

```{r}
tar_load(c(leaf_trait_modelling, leaf_inla_pred))
p_pred_leaf <- leaf_trait_modelling %>%
  pivot_longer(c(ldmc, sla), names_to = "trait", values_to = "values") %>%
  mutate(
    com = recode_factor(com, "Mono" = "Monospecific", "Poly" = "Diverse"),
    ms = recode_factor(ms, "Open" = "Open", "Patch" = "Nurse patch")
    ) %>%
  group_by(ms, com, watering, trait, species, ter) %>%
  summarise(n = sum(!is.na(values)), values = mean(values, na.rm = TRUE)) %>%
  filter(n >= 3) %>%
  ggplot(aes(y = values, x = ms, color = watering, shape = com)) +
  geom_jitter(alpha = .2) +
  geom_point(
    data = leaf_inla_pred %>%
      rename(trait = response) %>%
      mutate(
        com = recode_factor(com, "Mono" = "Monospecific", "Poly" = "Diverse"),
        ms = recode_factor(ms, "Open" = "Open", "Patch" = "Nurse patch")
      ), aes(y = mean), size = 2) +
  facet_grid(cols = vars(species), rows = vars(trait), scales = "free_y") +
  labs(
    x = "",
    y = "Leaf trait values",
    color = "Watering",
    shape = "Diversity") +
  theme_bw() +
  theme(legend.position = "bottom")
ggsave(
  filename = "p_pred_leaf.pdf",
  plot = p_pred_leaf,
  path = here("paper", "graphics"),
  scale = 1.8,
  width = 90,
  height = 90 * .5,
  units = "mm",
  dpi = "print"
)
```

```{r}
predicted_leaf_cap <- "Predictions of the leaf traits of beneficiary
plants from the statistical models. Shaded points display the raw data
averaged by terrace (N = 3 for each treatment)." %>%
str_replace_all("\\s+", " ")
```

```{r, fig.cap = predicted_leaf_cap}
knitr::include_graphics(here("paper", "graphics", "p_pred_leaf.pdf"))
```


# Tables

```{r}
r2_model <- biomass_modelling_r2 %>%
  filter(model == "log_mod_bm_tot_h") %>%
  slice(1) %>%
  pivot_longer(-model, names_to = "var", values_to = "values") %>%
  select(-model) %>%
  deframe() %>%
  round(., 2)
```

```{r}
mod_cap <- paste0("Coefficients of the statistical model predicting total
  biomass from basal diameter and vegetative height.", " R2 = ", r2_model["R2"],
  ", Adjusted R2 = ", r2_model["R2_adjusted"], ".") %>%
str_replace_all("\\s+", " ")
```



```{r}
broom::tidy(biomass_modelling$log_mod_bm_tot_h) %>%
  mutate(term = c(term_replacement(), response_replacement())[term]) %>%
  janitor::clean_names() %>%
  kbl(booktabs = T, caption = mod_cap, label = "pred-bm") %>%
  kable_styling(latex_options = c("hold_position"))
```

```{r}
leaf_nb_cap <- paste0("Number of leaf trait samples by treatment combination.") %>%
str_replace_all("\\s+", " ")
```


```{r leaf-nb, fig.cap = leaf_nb_cap}
tar_load(leaf_trait)
leaf_trait %>%
  pivot_longer(c(ldmc, sla), names_to = "trait", values_to = "values") %>%
  group_by(com, ms, watering, trait) %>%
  summarise(N = sum(!is.na(values))) %>%
  pivot_wider(names_from = "trait", values_from = "N") %>%
  rename(Diversity = com, Site = ms, Watering = watering) %>%
  kbl(booktabs = T,
    label = "tab-leaf-nb",
    caption = leaf_nb_cap) %>%
  add_header_above(c(" " = 3, "Number of data" = 2)) %>%
  collapse_rows(columns = c(1, 2), valign = "middle", latex_hline = "major") %>%
  kable_styling(latex_options = c("hold_position"))
```

```{r}
na_cap <- "Number of missing values by variable during the experiment. The vegetative height
of the dead saplings was not measured. Then total biomass estimation has than roughly
the same amount of missing values than vegetative height, far more than basal
diameter. However considering total biomass or basal diameter gave roughly the
same results (Fig. S2)." %>%
str_replace_all("\\s+", " ")
```


```{r na-fig, fig.cap = na_cap, eval = FALSE}
p_na_surv <- surv_data_modelling %>%
  select(duration_m, bm, d, h, survival) %>%
  pivot_longer(cols = c(bm, d, h, survival), names_to = "variable", values_to = "values") %>%
  group_by(duration_m, variable) %>%
  mutate(variable = response_replacement()[variable]) %>%
  summarise(n_na = sum(is.na(values))) %>%
  ggplot(aes(x = duration_m + 6, y = n_na)) +
  geom_line() +
  facet_grid(cols = vars(variable)) +
  labs(
    x = "Number of month since the beginning of the experiment",
    y = "Number of NAs") +
  theme_bw()
ggsave(
  filename = "p_na_surv.pdf",
  plot = p_na_surv,
  path = here("paper", "graphics"),
  scale = 2.4,
  width = 90,
  height = 90 * .3,
  units = "mm",
  dpi = "print"
)
knitr::include_graphics(here("paper", "graphics", "p_na_surv.pdf"))
```

```{r}
tar_load(rand_tab)

rand_tab_ok <- rand_tab %>%
  ungroup() %>%
  filter(response %in% c("ldmc", "sla", "bm", "d", "h")) %>%
  arrange(level, response) %>%
  mutate(
    level = str_to_title(level),
    response = response_replacement()[response],
    term = rand_term_replacement()[term]
  ) %>%
  filter(level == "Community") %>%
  select(
    `Model scale` = level,
    Variable = response,
    Term = term,
    `Random effect (s.d.)` = sd_ci
    ) %>%
  pivot_wider(names_from = "Term", values_from = "Random effect (s.d.)")


rand_cap <- "Standard deviations associated to  the stastistical models.
Gaussian error represents the general error term of the models. Plot effect was
not kept for the total biomass model (see methods). [95\\% CI]:
Credible Interval computed using Highest Posterior Density method." %>%
str_replace_all("\\s+", " ")

rand_tab_ok %>%
  select(-`Model scale`) %>%
  kbl(booktabs = T,
    label = "tab-rand",
    caption = rand_cap) %>%
  add_header_above(c(" " = 1, "Random effect (s.d.)" = 2)) %>%
  collapse_rows(columns = c(1, 2), valign = "middle", latex_hline = "major") %>%
  kable_styling(latex_options = c("hold_position"))
```


```{r}
tar_load(r2)
r2_tab <- r2 %>%
  filter(
    response %in% c("ldmc", "sla", "bm", "d", "h"),
    level == "community"
    ) %>%
  arrange(level, response) %>%
  select(
    `Model scale` = level,
    Variable = response,
    `R2 marg.` = r2_mvp_marg95hpdci,
    `R2 cond.` = r2_mvp_cond95hpdci
    ) %>%
  mutate(
    `Model scale` = str_to_title(`Model scale`),
    Variable = response_replacement()[Variable]
  )

r2_cap <- "R-Squared for the stastistical models. Marginal R-squared takes in account fixed effects only while
conditional R-squared accounts for the fixed and random effects. R-Squared were
not computed for survival because gaussian errors are not defined for logistic
regression (See methods). [95\\% CI]: Credible Interval computed using
Highest Posterior Density method." %>% str_replace_all("\\s+", " ")

r2_tab %>%
  select(-`Model scale`) %>%
  kbl(booktabs = T,
    label = "tab-r2",
    caption = r2_cap) %>%
  collapse_rows(columns = c(1), valign = "middle", latex_hline = "major") %>%
  kable_styling(latex_options = c("hold_position"))
```



